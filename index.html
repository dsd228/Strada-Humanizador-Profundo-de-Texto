<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="RedactaPro: Mejora tu escritura para sonar más humano y evadir detectores de IA con estilo moderno." />
  <title>RedactaPro - Escritura Humana Avanzada</title>
  
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap');
    
    :root {
      --color-primary: #059669; /* Emerald 600 */
      --color-secondary: #047857; /* Emerald 700 */
      --color-bg-light: #f8fafc; /* Slate 50 */
      --color-bg-medium: #f1f5f9; /* Slate 100 */
      --color-text-normal: #334155; /* Slate 700 */
      --color-text-muted: #64748b; /* Slate 500 */
      --color-accent: #2dd4bf; /* Teal 400 */
      --glass-bg: rgba(255, 255, 255, 0.5); /* Fondo semitransparente */
      --glass-blur: 10px; /* Intensidad del desenfoque */
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, var(--color-bg-light) 0%, var(--color-bg-medium) 100%);
      min-height: 100vh;
      scroll-behavior: smooth;
    }
    
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Poppins', sans-serif;
    }

    textarea, input, button, select {
      font-size: 1rem; /* 16px */
    }
    
    .btn-primary {
      background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
      color: white;
      border: none;
      border-radius: 0.75rem; /* 12px */
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(5, 150, 105, 0.3);
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.6); /* Fondo semitransparente */
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      color: var(--color-text-normal);
      border-radius: 0.75rem;
      padding: 0.75rem 1.5rem;
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.8);
      transform: translateY(-1px);
    }
    
    .input-textarea, .analysis-card, .stats-card, .header, .footer {
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 1.5rem; /* Más redondeado */
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
    }

    .input-textarea:focus {
      outline: none;
      border-color: #10b981; /* emerald-500 */
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
    }
    
    .progress-bar-container {
      background-color: rgba(255, 255, 255, 0.4);
      border-radius: 9999px; /* Full rounded */
      overflow: hidden;
    }
    .progress-bar-fill {
      background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
      height: 0.75rem; /* 12px */
      border-radius: 9999px;
      transition: width 0.5s ease-in-out;
    }

    /* Estilos para el feedback de copia */
    .toast-success {
      background-color: var(--color-primary);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      text-align: center;
      opacity: 0;
      animation: fadeInOut 2s forwards;
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 50;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06);
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
      20% { opacity: 1; transform: translateX(-50%) translateY(-10px); }
      80% { opacity: 1; transform: translateX(-50%) translateY(-10px); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    }
    
    /* Estilos para la sección de análisis */
    .analysis-card {
      background-color: var(--glass-bg);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
    }
    
    .analysis-title-icon {
      color: var(--color-accent); /* Teal 400 */
    }

    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 220px;
      background-color: #374151; /* Slate 800 */
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px 10px;
      position: absolute;
      z-index: 1;
      bottom: 125%; /* Position the tooltip above the element */
      left: 50%;
      margin-left: -110px; /* Use half of the width to center */
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.75rem; /* Smaller font */
      line-height: 1.2;
      border-radius: 0.5rem;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    .tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%; /* At the bottom of the tooltip */
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #374151 transparent transparent #374151;
    }

    /* Nuevos estilos para mejoras */
    .history-item {
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
      background: rgba(255, 255, 255, 0.3); /* Fondo glass */
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .history-item:hover {
      border-left-color: var(--color-primary);
      background: rgba(255, 255, 255, 0.5);
      transform: translateX(5px);
    }
    
    .stats-card {
      background: linear-gradient(135deg, rgba(240, 253, 244, 0.5) 0%, rgba(236, 253, 245, 0.5) 100%);
      border: 1px solid rgba(187, 247, 176, 0.4);
    }
    
    .export-option {
      transition: all 0.2s ease;
      background-color: white; /* Fondo blanco para las opciones de descarga */
    }
    .export-option:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .hidden {
      display: none;
    }

    /* Estilos para botones de pestaña activos */
    .tab-active {
      background: var(--color-primary);
      color: white;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .tab-inactive {
      color: var(--color-text-normal);
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .tab-inactive:hover {
      background: rgba(255, 255, 255, 0.8);
    }

  </style>
</head>
<body class="antialiased">
  <div id="app-container">
    <div class="min-h-screen flex flex-col">
      <!-- Header -->
      <header class="header sticky top-0 z-40 py-4 shadow-sm border-b border-gray-200/50 backdrop-blur-md">
        <div class="container mx-auto px-4 flex justify-between items-center">
          <div class="flex items-center gap-3">
            <svg class="w-7 h-7 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent">
              RedactaPro
            </h1>
          </div>
          <p class="hidden md:block text-slate-300 text-lg">Tu aliado para una escritura auténtica y natural.</p>
          <!-- Botones de navegación -->
          <div class="flex space-x-2">
            <button 
              id="write-tab"
              class="px-4 py-2 rounded-full text-sm font-medium transition-colors tab-active">
              Editor
            </button>
            <button 
              id="analyze-tab"
              class="px-4 py-2 rounded-full text-sm font-medium transition-colors tab-inactive">
              Análisis
            </button>
            <button 
              id="review-tab"
              class="px-4 py-2 rounded-full text-sm font-medium transition-colors tab-inactive">
              Resultado
            </button>
          </div>
        </div>
      </header>

      <main class="flex-grow container mx-auto px-4 py-8">
        <!-- Pestaña de Editor -->
        <div id="write-section">
          <div class="grid lg:grid-cols-5 gap-8">
            <!-- Editor y Configuración -->
            <div class="lg:col-span-2 space-y-6">
              <div class="analysis-card p-6">
                <div class="flex items-center gap-2 mb-4">
                  <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  <h2 class="text-xl font-semibold text-slate-100">Tu Texto Original</h2>
                </div>
                <textarea
                  id="input-text"
                  class="input-textarea w-full h-64 p-4 text-slate-300 bg-white/30 focus:ring-emerald-500 border-gray-300/50 focus:border-transparent"
                  rows="8"
                  placeholder="Pega tu texto aquí o cárgalo desde un archivo..."
                ></textarea>
                <div class="flex flex-wrap gap-3 mt-4">
                  <input type="file" accept=".txt, .md, .docx" id="file-input" class="hidden" />
                  <button id="load-file" class="btn-secondary flex-1">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-8.003 4 4 0 018.601-1.233A4 4 0 0116 7a4 4 0 01-3.191 4.829L11 15zm0 0a4 4 0 01-3.191-4.829c.777.284 1.591.45 2.409.45h1.114L11 15z"/>
                    </svg>
                    Cargar Archivo
                  </button>
                  <button id="clear-input-btn" class="btn-secondary flex-1">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m4-6v6M7 7h14a2 2 0 012 2v7a2 2 0 01-2 2h-14a2 2 0 01-2-2v-7a2 2 0 012-2z"/>
                    </svg>
                    Limpiar Texto
                  </button>
                </div>
              </div>

              <!-- Historial de conversiones -->
              <div id="history-container" class="analysis-card p-6 hidden">
                <div class="flex items-center gap-2 mb-4">
                  <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <h3 class="text-xl font-semibold text-slate-100">Historial Reciente</h3>
                </div>
                <div id="history-list" class="space-y-3">
                  <!-- Los elementos de historial se insertarán aquí dinámicamente -->
                </div>
              </div>

              <!-- Configuración de Humanización -->
              <div class="analysis-card p-6">
                <div class="flex items-center gap-2 mb-6">
                  <svg class="w-5 h-5 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.99.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  <h3 class="text-xl font-semibold text-slate-100">Ajustes de Humanización</h3>
                </div>
                
                <div class="space-y-5">
                  <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">
                      Profundidad de Modificación
                    </label>
                    <div class="grid grid-cols-3 gap-2">
                      <button
                        data-depth="suave"
                        class="py-2 px-3 rounded-lg text-sm font-medium transition-all duration-300 btn-primary shadow-sm">
                        Ligera
                      </button>
                      <button
                        data-depth="normal"
                        class="py-2 px-3 rounded-lg text-sm font-medium transition-all duration-300 btn-secondary">
                        Media
                      </button>
                      <button
                        data-depth="fuerte"
                        class="py-2 px-3 rounded-lg text-sm font-medium transition-all duration-300 btn-secondary">
                        Profunda
                      </button>
                    </div>
                  </div>

                  <div class="space-y-3 pt-4 border-t border-white/30">
                    <h4 class="text-md font-semibold text-slate-100">Enfoques</h4>
                    <label class="flex items-center gap-3 cursor-pointer group">
                      <input
                        type="checkbox"
                        id="styleVariation"
                        class="w-4 h-4 text-emerald-500 rounded border-slate-300/50 shadow-sm focus:ring-emerald-500 bg-white/20"
                      />
                      <span class="text-sm text-slate-300">Variación Estructural</span>
                      <span class="tooltip">
                        <span class="tooltiptext text-xs">Altera el orden de las frases y la construcción gramatical.</span>
                        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c-.548.505-.902 1.284-1.095 2.114-.193.83.046 1.639.797 2.245.813.607 1.756 1.144 2.796 1.49L13.5 17.483c.171.408.455.796.818.817.362.02.659-.314.818-.712.16-.407.268-.81.362-1.222.094-.412.150-.83.150-1.25V9.342c0-.538-.109-1.059-.306-1.541-.197-.482-.486-.932-.847-1.304a7.786 7.786 0 00-1.295-1.295A4.674 4.674 0 009.876 6.75c-.715.01-1.426.145-2.07.354-.793.245-1.543.584-2.224.973" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17.75l.001-.002" />
                        </svg>
                      </span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                      <input
                        type="checkbox"
                        id="naturalFlow"
                        class="w-4 h-4 text-emerald-500 rounded border-slate-300/50 shadow-sm focus:ring-emerald-500 bg-white/20"
                      />
                      <span class="text-sm text-slate-300">Fluidez Natural (Modismos)</span>
                      <span class="tooltip">
                        <span class="tooltiptext text-xs">Introduce expresiones coloquiales y ejemplos personales.</span>
                        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c-.548.505-.902 1.284-1.095 2.114-.193.83.046 1.639.797 2.245.813.607 1.756 1.144 2.796 1.49L13.5 17.483c.171.408.455.796.818.817.362.02.659-.314.818-.712.16-.407.268-.81.362-1.222.094-.412.150-.83.150-1.25V9.342c0-.538-.109-1.059-.306-1.541-.197-.482-.486-.932-.847-1.304a7.786 7.786 0 00-1.295-1.295A4.674 4.674 0 009.876 6.75c-.715.01-1.426.145-2.07.354-.793.245-1.543.584-2.224.973" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17.75l.001-.002" />
                        </svg>
                      </span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                      <input
                        type="checkbox"
                        id="toneAdjustment"
                        class="w-4 h-4 text-emerald-500 rounded border-slate-300/50 shadow-sm focus:ring-emerald-500 bg-white/20"
                      />
                      <span class="text-sm text-slate-300">Ajuste de Tono y Ritmo</span>
                      <span class="tooltip">
                        <span class="tooltiptext text-xs">Varía la longitud y el inicio de las oraciones para un mejor flujo.</span>
                        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c-.548.505-.902 1.284-1.095 2.114-.193.83.046 1.639.797 2.245.813.607 1.756 1.144 2.796 1.49L13.5 17.483c.171.408.455.796.818.817.362.02.659-.314.818-.712.16-.407.268-.81.362-1.222.094-.412.150-.83.150-1.25V9.342c0-.538-.109-1.059-.306-1.541-.197-.482-.486-.932-.847-1.304a7.786 7.786 0 00-1.295-1.295A4.674 4.674 0 009.876 6.75c-.715.01-1.426.145-2.07.354-.793.245-1.543.584-2.224.973" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17.75l.001-.002" />
                        </svg>
                      </span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                      <input
                        type="checkbox"
                        id="readabilityFocus"
                        class="w-4 h-4 text-emerald-500 rounded border-slate-300/50 shadow-sm focus:ring-emerald-500 bg-white/20"
                      />
                      <span class="text-sm text-slate-300">Claridad y Legibilidad</span>
                      <span class="tooltip">
                        <span class="tooltiptext text-xs">Simplifica jerga y asegura que las ideas sean fáciles de seguir.</span>
                        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c-.548.505-.902 1.284-1.095 2.114-.193.83.046 1.639.797 2.245.813.607 1.756 1.144 2.796 1.49L13.5 17.483c.171.408.455.796.818.817.362.02.659-.314.818-.712.16-.407.268-.81.362-1.222.094-.412.150-.83.150-1.25V9.342c0-.538-.109-1.059-.306-1.541-.197-.482-.486-.932-.847-1.304a7.786 7.786 0 00-1.295-1.295A4.674 4.674 0 009.876 6.75c-.715.01-1.426.145-2.07.354-.793.245-1.543.584-2.224.973" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17.75l.001-.002" />
                        </svg>
                      </span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                      <input
                        type="checkbox"
                        id="sentenceLengthVariation"
                        class="w-4 h-4 text-emerald-500 rounded border-slate-300/50 shadow-sm focus:ring-emerald-500 bg-white/20"
                      />
                      <span class="text-sm text-slate-300">Variación Longitud Oración</span>
                      <span class="tooltip">
                        <span class="tooltiptext text-xs">Asegura una mezcla de oraciones cortas y largas.</span>
                        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c-.548.505-.902 1.284-1.095 2.114-.193.83.046 1.639.797 2.245.813.607 1.756 1.144 2.796 1.49L13.5 17.483c.171.408.455.796.818.817.362.02.659-.314.818-.712.16-.407.268-.81.362-1.222.094-.412.150-.83.150-1.25V9.342c0-.538-.109-1.059-.306-1.541-.197-.482-.486-.932-.847-1.304a7.786 7.786 0 00-1.295-1.295A4.674 4.674 0 009.876 6.75c-.715.01-1.426.145-2.07.354-.793.245-1.543.584-2.224.973" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17.75l.001-.002" />
                        </svg>
                      </span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                      <input
                        type="checkbox"
                        id="connectorVariety"
                        class="w-4 h-4 text-emerald-500 rounded border-slate-300/50 shadow-sm focus:ring-emerald-500 bg-white/20"
                      />
                      <span class="text-sm text-slate-300">Variedad de Conectores</span>
                      <span class="tooltip">
                        <span class="tooltiptext text-xs">Evita conectores repetitivos o muy asociados a IA.</span>
                        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c-.548.505-.902 1.284-1.095 2.114-.193.83.046 1.639.797 2.245.813.607 1.756 1.144 2.796 1.49L13.5 17.483c.171.408.455.796.818.817.362.02.659-.314.818-.712.16-.407.268-.81.362-1.222.094-.412.150-.83.150-1.25V9.342c0-.538-.109-1.059-.306-1.541-.197-.482-.486-.932-.847-1.304a7.786 7.786 0 00-1.295-1.295A4.674 4.674 0 009.876 6.75c-.715.01-1.426.145-2.07.354-.793.245-1.543.584-2.224.973" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17.75l.001-.002" />
                        </svg>
                      </span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                      <input
                        type="checkbox"
                        id="lexicalRichness"
                        class="w-4 h-4 text-emerald-500 rounded border-slate-300/50 shadow-sm focus:ring-emerald-500 bg-white/20"
                      />
                      <span class="text-sm text-slate-300">Riqueza Léxica</span>
                      <span class="tooltip">
                        <span class="tooltiptext text-xs">Utiliza sinónimos menos comunes pero naturales.</span>
                        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c-.548.505-.902 1.284-1.095 2.114-.193.83.046 1.639.797 2.245.813.607 1.756 1.144 2.796 1.49L13.5 17.483c.171.408.455.796.818.817.362.02.659-.314.818-.712.16-.407.268-.81.362-1.222.094-.412.150-.83.150-1.25V9.342c0-.538-.109-1.059-.306-1.541-.197-.482-.486-.932-.847-1.304a7.786 7.786 0 00-1.295-1.295A4.674 4.674 0 009.876 6.75c-.715.01-1.426.145-2.07.354-.793.245-1.543.584-2.224.973" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17.75l.001-.002" />
                        </svg>
                      </span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                      <input
                        type="checkbox"
                        id="avoidRepetition"
                        class="w-4 h-4 text-emerald-500 rounded border-slate-300/50 shadow-sm focus:ring-emerald-500 bg-white/20"
                      />
                      <span class="text-sm text-slate-300">Evitar Repeticiones</span>
                      <span class="tooltip">
                        <span class="tooltiptext text-xs">Minimiza la repetición de palabras clave y estructuras.</span>
                        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c-.548.505-.902 1.284-1.095 2.114-.193.83.046 1.639.797 2.245.813.607 1.756 1.144 2.796 1.49L13.5 17.483c.171.408.455.796.818.817.362.02.659-.314.818-.712.16-.407.268-.81.362-1.222.094-.412.150-.83.150-1.25V9.342c0-.538-.109-1.059-.306-1.541-.197-.482-.486-.932-.847-1.304a7.786 7.786 0 00-1.295-1.295A4.674 4.674 0 009.876 6.75c-.715.01-1.426.145-2.07.354-.793.245-1.543.584-2.224.973" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17.75l.001-.002" />
                        </svg>
                      </span>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Botón de Procesamiento y Barra de Progreso -->
            <div class="lg:col-span-3 flex flex-col justify-end">
              <div class="analysis-card p-6">
                <h3 class="text-lg font-semibold text-slate-100 mb-4">Acción</h3>
                <div id="progress-container" class="mb-4 hidden">
                  <div class="flex justify-between items-center mb-1">
                    <span class="text-sm text-slate-300">Procesando...</span>
                    <span id="progress-percent" class="text-sm font-medium text-emerald-400">0%</span>
                  </div>
                  <div class="progress-bar-container h-3">
                    <div
                      id="progress-bar"
                      class="progress-bar-fill"
                      style="width: 0%"
                    ></div>
                  </div>
                </div>
                <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 relative" role="alert">
                  <strong class="font-bold">Error:</strong>
                  <span id="error-text" class="block sm:inline"></span>
                </div>
                <button
                  id="process-btn"
                  class="btn-primary w-full flex items-center justify-center gap-2 py-3"
                >
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                  Humanizar y Analizar
                </button>
                <div id="input-warning" class="mt-4 p-3 bg-yellow-50/20 border border-yellow-200/50 rounded-lg text-yellow-100 text-sm hidden">
                  <svg class="w-5 h-5 inline mr-2 text-yellow-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                  Introduce texto o carga un archivo para comenzar
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pestaña de Resultados y Análisis -->
        <div id="review-section" class="hidden">
          <div class="grid lg:grid-cols-3 gap-8 fade-in">
            <div class="lg:col-span-2">
              <div class="analysis-card p-6">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h2 class="text-xl font-semibold text-slate-100">Texto Humanizado</h2>
                  </div>
                  <div class="flex gap-2">
                    <button
                      id="copy-btn"
                      class="flex items-center gap-2 px-3 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-colors text-sm shadow-md"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                      Copiar
                    </button>
                    <div class="relative group">
                      <button id="download-btn" class="flex items-center gap-2 px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm shadow-md">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.707.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Descargar
                      </button>
                      <div class="absolute right-0 mt-1 w-48 bg-white/80 backdrop-blur-md rounded-lg shadow-lg py-2 z-10 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 border border-gray-200/50">
                        <button data-format="txt" class="export-option block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-100/70">
                          Como archivo de texto (.txt)
                        </button>
                        <button data-format="doc" class="export-option block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-100/70">
                          Como documento Word (.doc)
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div 
                  id="output-text"
                  class="w-full min-h-64 p-4 border border-gray-300/50 rounded-xl bg-white/10 text-slate-300 leading-relaxed whitespace-pre-wrap font-sans"
                >
                  El texto mejorado aparecerá aquí...
                </div>
              </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
              <!-- Análisis de "Humanidad" -->
              <div class="analysis-card p-6">
                <div class="flex items-center gap-2 mb-6">
                  <svg class="w-5 h-5 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                  </svg>
                  <h3 class="text-xl font-semibold text-slate-100">Análisis de "Calidad Humana"</h3>
                </div>
                
                <div class="space-y-4">
                  <div class="bg-gradient-to-r from-yellow-50/20 to-orange-50/20 rounded-lg p-4 border border-orange-200/40">
                    <div class="flex justify-between text-sm text-slate-300 mb-2">
                      <span>Probabilidad de ser Humano</span>
                      <span id="analysis-score" class="font-bold text-yellow-300">0%</span>
                    </div>
                    <div class="progress-bar-container h-3">
                      <div 
                        id="analysis-bar"
                        class="progress-bar-fill"
                        style="width: 0%"
                      ></div>
                    </div>
                    <p id="analysis-feedback" class="mt-2 text-sm text-orange-200">
                      Introduce texto y procesa para ver el análisis.
                    </p>
                  </div>
                </div>
              </div>

              <!-- Estadísticas de mejora -->
              <div class="stats-card p-6 rounded-xl">
                <div class="flex items-center gap-2 mb-4">
                  <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                  </svg>
                  <h3 class="text-xl font-semibold text-slate-100">Estadísticas</h3>
                </div>
                
                <div class="space-y-4">
                  <div class="flex justify-between items-center">
                    <span class="text-slate-300">Palabras antes:</span>
                    <span id="words-before" class="font-semibold text-slate-200">0</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-slate-300">Palabras después:</span>
                    <span id="words-after" class="font-semibold text-slate-200">0</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-slate-300">Legibilidad:</span>
                    <span id="readability-score" class="font-semibold text-slate-200">0%</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-slate-300">Mejora general:</span>
                    <span id="improvement-score" class="font-semibold text-emerald-400">+0%</span>
                  </div>
                </div>
              </div>

              <!-- Acciones rápidas -->
              <div class="analysis-card p-6">
                <h3 class="text-lg font-semibold text-slate-100 mb-4">Acciones Rápidas</h3>
                <div class="space-y-3">
                  <button
                    id="another-text-btn"
                    class="w-full btn-secondary text-center"
                  >
                    Procesar otro texto
                  </button>
                  <button
                    id="clear-all-btn"
                    class="w-full btn-secondary text-center"
                  >
                    Limpiar todo y comenzar de nuevo
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pestaña de Análisis -->
        <div id="analyze-section" class="hidden text-center py-20">
          <h2 class="text-2xl font-bold text-slate-200 mb-4">¡Listo para procesar!</h2>
          <p class="text-lg text-slate-300 mb-8">Ajusta las opciones de humanización y haz clic en 'Humanizar y Analizar' para ver los resultados.</p>
          <button
            id="process-from-analyze"
            class="btn-primary py-3 px-6 text-lg flex items-center justify-center gap-2 mx-auto"
          >
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            Humanizar y Analizar
          </button>
        </div>
      </main>

      <!-- Toast de Copia Exitosa -->
      <div id="copy-toast" class="toast-success hidden">¡Texto copiado al portapapeles!</div>

      <!-- Footer -->
      <footer class="header py-6 border-t border-gray-200/50 mt-8 backdrop-blur-md">
        <div class="container mx-auto px-4 text-center text-sm text-slate-300">
          <p>RedactaPro © 2024. Todas las operaciones se realizan localmente en tu navegador.</p>
          <p class="mt-1">Diseñado para mejorar la naturalidad y autenticidad de tu escritura.</p>
        </div>
      </footer>
    </div>
  </div>

  <script>
    // --- DATOS ---
    const connectors = [
      'Bueno,', 'Mira,', 'La verdad es que,', 'O sea,', 'Tipo,',
      'Como quien no quiere la cosa,', 'Al final del día,', 'Si me preguntas,',
      'No sé si me explico,', 'En criollo,', 'Te cuento que,', 'Fíjate que,',
      'A ver,', 'Por otro lado,', 'En contraste,', 'De hecho,',
      'Asimismo,', 'No obstante,', 'Así pues,', 'De ahí que,',
      'Vale,', 'En fin,', 'Para que te hagas una idea,', 'Vamos, que,',
      'Pues mira,', 'A decir verdad,', 'Entre tú y yo,', 'No te voy a engañar,',
      'Para serte sincero,', 'Si te soy honesto,', 'Por si no lo sabías,',
      'Es más,', 'De cualquier modo,', 'En cualquier caso,'
    ];
    
    const aiConectors = [
      "además", "asimismo", "por lo tanto", "en conclusión", 
      "por consiguiente", "en consecuencia", "así pues", "de hecho",
      "por ende", "en resumen", "finalmente", "en definitiva", "sin embargo",
      "no obstante", "adicionalmente", "subsecuentemente", "en primer lugar",
      "en segundo lugar", "en tercer lugar", "posteriormente"
    ];

    const humanIdioms = [
      'cuesta abajo', 'pan comido', 'ponerse las pilas', 'dar en el clavo',
      'tirar la casa por la ventana', 'estar en las nubes', 'no tener pelos en la lengua',
      'ser uña y carne', 'hacer la vista gorda', 'meter la pata', 'buscarle la quinta pata al gato',
      'donde hubo fuego, cenizas quedan', 'el que madruga, Dios le ayuda', 'la curiosidad mató al gato',
      'más vale pájaro en mano que ciento volando', 'no hay mal que dure cien años, ni cuerpo que lo resista',
      'en un abrir y cerrar de ojos', 'poner los puntos sobre las íes', 'sacar las castañas del fuego',
      'a las primeras de cambio', 'no pegar ojo', 'estar en el quinto pino', 'irse por las ramas',
      'montar un pollo', 'estar en la luna de Valencia', 'dar la vuelta a la tortilla',
      'estar hasta las narices', 'dormirse en los laureles', 'hacerse el sueco', 'no ver tres en un burro'
    ];
    
    const richSynonyms = {
      "importante": ["crucial", "trascendental", "fundamental", "esencial", "relevante", "clave", "imperativo", "decisivo", "vital", "significativo"],
      "decir": ["manifestar", "expresar", "comunicar", "señalar", "indicar", "proclamar", "declarar", "articular", "mencionar", "comentar", "exponer"],
      "usar": ["emplear", "utilizar", "recurrir a", "aplicar", "desplegar", "implementar", "valerse de", "hacer uso de", "manejar", "servirse de"],
      "bueno": ["adecuado", "óptimo", "pertinente", "idóneo", "propicio", "beneficioso", "acertado", "favorable", "conveniente", "correcto"],
      "mucho": ["considerablemente", "sustancialmente", "ampliamente", "notablemente", "abundantemente", "significativamente", "profusamente", "extensamente"],
      "gran": ["enorme", "amplio", "extenso", "considerable", "significativo", "voluminoso", "colosal", "monumental", "vastísimo", "magnífico"],
      "poder": ["capacidad", "facultad", "potestad", "habilidad", "competencia", "autoridad", "potencial", "posibilidad"],
      "tener": ["poseer", "disponer de", "contar con", "ostentar", "acaparar", "albergar", "conservar", "estar dotado de"],
      "crear": ["generar", "concebir", "producir", "elaborar", "forjar", "gestar", "desarrollar", "inventar", "establecer", "dar forma"],
      "mejorar": ["optimizar", "perfeccionar", "pulir", "refinar", "potenciar", "elevar", "enriquecer", "fortalecer", "apsack"],
      "necesario": ["imprescindible", "indispensable", "requerido", "obligatorio", "preciso", "inexorable", "fundamental", "esencial"],
      "hacer": ["realizar", "efectuar", "ejecutar", "llevar a cabo", "confeccionar", "elaborar", "producir", "componer"],
      "utilizar": ["emplear", "usar", "aplicar", "manipular", "operar", "explotar", "manejar", "servirse de"],
      "mostrar": ["exhibir", "presentar", "demostrar", "evidenciar", "revelar", "exponer", "visualizar", "patentizar"],
      "cambiar": ["modificar", "alterar", "transformar", "variar", "mutar", "convertir", "transmutar", "reconfigurar"]
    };

    // --- ESTADO DE LA APLICACIÓN ---
    let appState = {
      inputText: '',
      outputText: '',
      isProcessing: false,
      analysisScore: 0,
      processingProgress: 0,
      activeTab: 'write',
      conversionHistory: [],
      stats: { wordsBefore: 0, wordsAfter: 0, readability: 0 },
      settings: {
        depth: 'suave', // 'suave', 'normal', 'fuerte'
        styleVariation: true,
        naturalFlow: true,
        toneAdjustment: true,
        readabilityFocus: true,
        sentenceLengthVariation: true,
        connectorVariety: true,
        lexicalRichness: true,
        avoidRepetition: true,
      }
    };

    // --- FUNCIONES DE UTILIDAD ---
    function cleanText(text) {
      return text
        .replace(/[\u200B-\u200D\uFEFF]/g, '') // Caracteres invisibles
        .replace(/[\u00A0\u1680\u2000-\u200A\u202F\u205F\u3000]/g, ' ') // Espacios extraños
        .replace(/[\r\n]{3,}/g, '\n\n') // Saltos excesivos
        .replace(/[ \t]+/g, ' ') // Espacios múltiples
        .replace(/ +([,.!?¿¡:]+)/g, '$1') // Espacios antes de puntuación
        .replace(/([¿¡]) +/g, '$1') // Espacios después de signos de interrogación/exclamación
        .trim();
    }

    function calculateReadability(text) {
      const words = text.split(/\s+/).filter(w => w.length > 0).length;
      const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
      const characters = text.replace(/\s+/g, '').length;
      
      if (words === 0 || sentences === 0) return 100;
      
      // Fórmula simplificada de legibilidad (similar a Flesch-Kincaid adaptada)
      // Un puntaje más alto significa más fácil de leer.
      // Ajustado para ser más amigable con el estilo humano.
      const readabilityScore = 206.835 - 1.015 * (words / sentences) - 84.6 * (words / characters * 100);
      return Math.max(0, Math.min(100, readabilityScore));
    }

    function deepSemanticRewrite(text, settings) {
      let paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 5);
      
      if (paragraphs.length > 3) {
        const intro = paragraphs.shift();
        const conclusion = paragraphs.pop();
        let body = paragraphs;
        
        // Reordenar párrafos del cuerpo
        for (let i = body.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [body[i], body[j]] = [body[j], body[i]];
        }
        
        if (settings.depth === 'fuerte' && body.length > 1) {
          body.reverse();
        }
        
        paragraphs = [intro, ...body, conclusion];
      }

      return paragraphs.map(para => {
        let sentences = para.split(/(?<=[.!?])\s+/).filter(s => s.trim());
        
        // Variación Estructural (si está activado)
        if (settings.styleVariation && sentences.length > 3 && Math.random() < 0.85) {
          const patterns = [
            (s) => [s[1], s[2], s[0], ...s.slice(3)], // Mover las primeras 3
            (s) => ["Para ilustrar,", s[2], s[0], s[1], ...s.slice(3)], // Insertar "Para ilustrar"
            (s) => [s[s.length - 1], "En realidad,", ...s.slice(0, -1)], // Mover la última al principio
            (s) => [s[0], "No obstante,", s[1], s[2], ...s.slice(3)], // Insertar conector
            (s) => [s[1], "Y es que,", s[0], ...s.slice(2)], // Reordenar y añadir conector
            (s) => [s[0], s[2], "Por cierto,", s[1], ...s.slice(3)], // Insertar frase con conector
            (s) => ["Resulta que,", s[1], s[0], ...s.slice(2)], // Añadir "Resulta que"
            (s) => [s[1], s[0], "Sin embargo,", ...s.slice(2)] // Reordenar y añadir "Sin embargo"
          ];
          
          // Seleccionar un patrón aleatorio
          const pattern = patterns[Math.floor(Math.random() * patterns.length)];
          sentences = pattern(sentences);
        }
        
        return sentences.join(' ');
      }).join('\n\n');
    }

    function translationSimulation(text, settings) {
      let result = text;
      // Patrones de "traducción" simplificados
      const transformations = [
        t => t.replace(/(\w+)\s+de\s+(\w+)/g, '$2 $1'), // a de b -> b a
        t => t.replace(/(\w+)\s+(\w+)\s+(\w+)/g, '$3 $1 $2'), // a b c -> c a b
        t => t.replace(/(\w+)\s+y\s+(\w+)/g, '$1 e $2'), // y -> e si es apropiado
        t => t.replace(/(\w+)\s+o\s+(\w+)/g, '$1 u $2'), // o -> u si es apropiado
        t => t.replace(/(\w+),\s+(\w+)/g, '$2, $1'), // a, b -> b, a
        t => t.replace(/(\w+)\s+que\s+(\w+)/g, '$2 el cual $1'), // a que b -> b el cual a
        t => t.replace(/un\s+(\w+)\s+(\w+)/g, 'un $2 y $1'), // un a b -> un b y a
        t => t.replace(/(\w+)\s+del\s+(\w+)/g, '$2 $1'), // a del b -> b a
        t => t.replace(/(\w+)\s+al\s+(\w+)/g, '$2 $1'), // a al b -> b a
        t => t.replace(/(\w+)\s+en\s+el\s+(\w+)/g, '$2 $1') // a en el b -> b a
      ];
      
      const steps = settings.depth === 'fuerte' ? 5 : settings.depth === 'normal' ? 3 : 1; 
      
      for (let i = 0; i < steps; i++) {
        if (settings.styleVariation) {
          // Aplicar una transformación aleatoria
          const transform = transformations[Math.floor(Math.random() * transformations.length)];
          result = transform(result);
        }
        if (settings.lexicalRichness && Math.random() < 0.7) { // Probabilidad de enriquecer léxico
          for (const [word, synonyms] of Object.entries(richSynonyms)) {
            const regex = new RegExp(`\\b${word}\\b`, 'gi');
            result = result.replace(regex, () => {
              if (Math.random() < 0.6) { // 60% de probabilidad de reemplazar
                return synonyms[Math.floor(Math.random() * synonyms.length)];
              }
              return word; // Mantener la palabra original
            });
          }
        }
      }
      
      return result;
    }

    function addNaturalFlow(text, settings) {
      let paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 5);
      
      return paragraphs.map((para, idx) => {
        let sentences = para.split(/(?<=[.!?])\s+/).filter(s => s.trim());
        
        // Variedad de Conectores (si está activado y no es el primer párrafo)
        if (settings.connectorVariety && idx > 0 && Math.random() < 0.7) { 
          let connector = connectors[Math.floor(Math.random() * connectors.length)];
          // Evitar conectores que suenan muy de IA
          if (aiConectors.some(ac => connector.toLowerCase().includes(ac)) && Math.random() < 0.6) { 
              connector = connectors[Math.floor(Math.random() * connectors.length)]; // Reintentar
          }
          if (connector) {
            // Poner la primera letra en minúscula si ya no lo está
            sentences[0] = `${connector} ${sentences[0].charAt(0).toLowerCase() + sentences[0].slice(1)}`;
          }
        }
        
        // Fluidez Natural (Modismos y ejemplos)
        if (settings.naturalFlow && sentences.length > 2 && Math.random() < 0.5) {
          const insertAt = Math.floor(sentences.length / 2); // Insertar en medio
          const choice = Math.random();
          if (choice < 0.4) { 
            const idiom = humanIdioms[Math.floor(Math.random() * humanIdioms.length)];
            sentences.splice(insertAt, 0, `Es como dicen por ahí, ${idiom}.`);
          } else if (choice < 0.8) { 
            const examples = [
              'yo mismo me acuerdo de una vez que...',
              'me pasó algo parecido el otro día...',
              'imagínate la escena:',
              'recuerdo perfectamente cuando...',
              'no te vas a creer lo que pasó...',
              'fue una situación bastante curiosa...'
            ];
            sentences.splice(insertAt, 0, `Por ejemplo, ${examples[Math.floor(Math.random() * examples.length)]}`);
          }
        }
        
        // Introducir pausas o muletillas (profundidad fuerte)
        if (settings.depth === 'fuerte' && Math.random() < 0.4) {
          const sentenceIdx = Math.floor(Math.random() * sentences.length);
          if (sentences[sentenceIdx].split(' ').length > 5) {
            const words = sentences[sentenceIdx].split(' ');
            const repeatIndex = Math.floor(Math.random() * (words.length - 2)) + 1;
            // Evitar repetición inmediata de la misma palabra
            if (words[repeatIndex] && words[repeatIndex -1] !== words[repeatIndex]) { 
              words.splice(repeatIndex, 0, words[repeatIndex]); // Duplicar palabra
              sentences[sentenceIdx] = words.join(' ');
            }
          }
        }
        
        if (settings.depth === 'fuerte' && Math.random() < 0.3) { // Más muletillas
          const pause = ['eh...', 'pues...', 'bueno...', 'digamos...', 'verá...', 'o sea...', 'este...', 'mmh...'];
          const insertAt = Math.floor(Math.random() * sentences.length);
          sentences[insertAt] = sentences[insertAt].replace(/^/, `${pause[Math.floor(Math.random() * pause.length)]} `);
        }
        
        return sentences.join(' ');
      }).join('\n\n');
    }

    function adjustToneAndReadability(text, settings) {
      let paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 5);
      let processedParagraphs = [];
      let sentenceLengths = []; 

      paragraphs.forEach(para => {
        let sentences = para.split(/(?<=[.!?])\s+/).filter(s => s.trim());
        sentenceLengths.push(...sentences.map(s => s.split(/\s+/).length));
        processedParagraphs.push(sentences);
      });

      const avgSentenceLength = sentenceLengths.length > 0 ? sentenceLengths.reduce((a, b) => a + b, 0) / sentenceLengths.length : 1;
      const stdDevSentenceLength = sentenceLengths.length > 0 ? Math.sqrt(sentenceLengths.reduce((acc, val) => acc + Math.pow(val - avgSentenceLength, 2), 0) / sentenceLengths.length) : 0;

      return processedParagraphs.map((paraSentences, pIdx) => {
        let finalSentences = paraSentences.map((sentence, idx) => {
          let processed = sentence.trim();
          const currentSentenceLength = processed.split(/\s+/).length;

          // Variación de Longitud de Oración
          if (settings.sentenceLengthVariation) {
            const thresholdShorten = avgSentenceLength + 6; // Oraciones más largas que el promedio + 6 palabras
            const thresholdLengthen = avgSentenceLength - 5; // Oraciones más cortas que el promedio - 5 palabras
            const variationFactor = stdDevSentenceLength > 5 ? 0.7 : 0.4; // Más variación si ya hay dispersión

            if (currentSentenceLength > thresholdShorten && Math.random() < variationFactor) {
              const breakPoint = Math.max(10, processed.lastIndexOf(' ', Math.floor(processed.length / 2)));
              if (breakPoint > 5) { // Asegurar que el punto de corte no sea al inicio
                const firstPart = processed.slice(0, breakPoint);
                const secondPart = processed.slice(breakPoint + 1);
                processed = `${firstPart}. ${secondPart.charAt(0).toLowerCase() + secondPart.slice(1)}`;
            }} else if (currentSentenceLength < thresholdLengthen && Math.random() < variationFactor * 0.6) { // Menos probabilidad de alargar
              const clauses = ['y esto es importante porque', 'lo cual significa que', 'y esto permite que', 'debido a que', 'algo que, en mi opinión,', 'lo que nos lleva a pensar que', 'dando como resultado que', 'y por eso es que'];
              processed = `${processed} ${clauses[Math.floor(Math.random() * clauses.length)]} ...`; 
            }
          }

          // Ajuste de Tono y Legibilidad
          if (settings.toneAdjustment || settings.readabilityFocus) {
            // Dividir oraciones largas y complejas si la legibilidad lo requiere
            if (settings.readabilityFocus && processed.length > 50 && Math.random() < 0.3) {
              const mid = Math.floor(processed.length / 2);
              const breakAt = processed.lastIndexOf(' ', mid);
              if (breakAt > 15) { // Punto de corte razonable
                const first = processed.slice(0, breakAt);
                const second = processed.slice(breakAt + 1);
                processed = `${first}. ${second.charAt(0).toUpperCase() + second.slice(1)}.`;
              }
            }
            
            // Añadir introducciones a oraciones (tono más conversacional)
            if (settings.toneAdjustment && idx > 0 && Math.random() < 0.3) {
              const introClauses = [
                'Aunque parezca mentira,', 'Cuando menos te lo esperas,', 
                'Justo en ese momento,', 'Después de todo lo dicho,', 'Si bien es cierto que,',
                'Cabe destacar que,', 'Por si fuera poco,', 'Para sorpresa de muchos,',
                'Contrario a lo que se piensa,', 'A juzgar por lo visto,', 'De hecho,', 'Y es que,'
              ];
              const clause = introClauses[Math.floor(Math.random() * introClauses.length)];
              processed = `${clause} ${processed.charAt(0).toLowerCase() + processed.slice(1)}`;
            }
            
            // Simplificar jerga o palabras complejas (legibilidad)
            if (settings.readabilityFocus && Math.random() < 0.25) {
              const formalToInformal = {
                "implementar": "usar", "optimizar": "mejorar", "paradigma": "enfoque",
                "sinergia": "colaboración", "efectuar": "hacer", "procedimiento": "paso",
                "facilitar": "ayudar", "consecuentemente": "por eso", "no obstante": "pero",
                "por consiguiente": "así que", "en consecuencia": "por lo tanto",
                "utilizar": "usar", "visualizar": "ver", "finalizar": "terminar",
                "acelerar": "agilizar", "mitigar": "reducir", "viable": "posible",
                "demostrar": "mostrar", "evaluar": "analizar", "estrategia": "plan"
              };
              for (const [formal, informal] of Object.entries(formalToInformal)) {
                const regex = new RegExp(`\\b${formal}\\b`, 'gi');
                if (regex.test(processed)) {
                  processed = processed.replace(regex, informal);
                  break; // Solo reemplazar una palabra por oración para mantener naturalidad
                }
              }
            }
          }
          
          return processed;
        });
        
        // Reordenar frases dentro del párrafo para variar el flujo
        if (settings.sentenceLengthVariation && finalSentences.length > 1) {
          finalSentences.sort((a, b) => {
            const lenA = a.split(/\s+/).length;
            const lenB = b.split(/\s+/).length;
            // Ordenar aleatoriamente, pero con tendencia a mezclar cortas y largas
            return Math.random() < 0.5 ? lenA - lenB : lenB - lenA;
          });
        }

        return finalSentences.join(' ');
      }).join('\n\n');
    }

    // Función para simular análisis de IA (evalúa qué tan "humano" suena)
    function simulateStyleAnalysis(text, settings) {
      const words = text.toLowerCase().split(/\W+/).filter(w => w.length > 0);
      const wordCount = words.length;
      const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
      const sentenceCount = sentences.length;
      if (sentenceCount === 0 || wordCount === 0) return 0; // Evitar división por cero

      const avgSentenceLength = wordCount / sentenceCount;
      const sentenceWordCounts = sentences.map(s => s.split(/\s+/).length);
      // Desviación estándar de la longitud de las oraciones (indicador de 'burstiness')
      const stdDevSentenceLength = Math.sqrt(sentenceWordCounts.reduce((acc, val) => acc + Math.pow(val - avgSentenceLength, 2), 0) / sentenceCount);

      let aiScore = 0; // Puntuación de similitud con IA (0 = humano, 100 = IA)
      let totalPossibleScore = 100; // Base para normalizar

      // 1. Variación de Longitud de Oración ('Burstiness')
      // Poca variación = suena más a IA
      const lengthVariationScore = Math.max(0, 40 - (stdDevSentenceLength * 3)); // Penaliza poca variación
      aiScore += lengthVariationScore;
      
      // 2. Riqueza Léxica (Diversidad de Palabras)
      const uniqueWords = new Set(words.filter(w => w.length > 3)).size;
      const lexicalDiversity = uniqueWords / words.filter(w => w.length > 3).length || 0;
      // Penaliza baja diversidad léxica
      const lexicalScore = Math.max(0, lexicalDiversity < 0.25 ? 40 : lexicalDiversity < 0.4 ? 20 : 0);
      aiScore += lexicalScore;

      // 3. Uso de Conectores (Frecuencia de conectores típicos de IA)
      let aiConnectorCount = 0;
      const sentenceTokens = sentences.flatMap(s => s.toLowerCase().split(/[\s,.!?;:]+/).filter(w => w.length > 0));
      aiConnectorCount = sentenceTokens.filter(w => aiConectors.includes(w)).length;
      const connectorFrequency = (aiConnectorCount / sentenceCount) * 100;
      // Penaliza alta frecuencia de conectores de IA
      const connectorScore = connectorFrequency > 15 ? 50 : connectorFrequency > 5 ? 25 : 0;
      aiScore += connectorScore;
      
      // 4. Patrones de estructura (Repetición de inicios de frase)
      const sentenceStarts = sentences.map(s => s.trim().split(/\s+/)[0]?.toLowerCase());
      const startCounts = {};
      sentenceStarts.forEach(start => { if (start) startCounts[start] = (startCounts[start] || 0) + 1; });
      const mostFrequentStartCount = Object.values(startCounts).reduce((max, count) => Math.max(max, count), 0);
      const repetitionRatio = (mostFrequentStartCount / sentenceCount) * 100;
      // Penaliza alta repetición de inicios
      const repetitionPenalty = repetitionRatio > 30 ? 30 : repetitionRatio > 20 ? 15 : 0;
      aiScore += repetitionPenalty;

      // Normalizar la puntuación AI y calcular la calidad humana
      const normalizedAIScore = Math.min(100, aiScore); // Asegurarse de que no exceda 100
      const humanQualityScore = Math.max(0, 100 - normalizedAIScore);

      return humanQualityScore;
    }

    // --- FUNCIONES DE PROCESAMIENTO ---
    async function processText() {
      const inputText = document.getElementById('input-text').value.trim();
      if (!inputText) {
        showError("Por favor, introduce o pega texto para procesar.");
        return;
      }
      
      appState.inputText = inputText; // Guardar entrada original
      appState.isProcessing = true;
      appState.activeTab = 'analyze'; // Ir a la pestaña de análisis
      updateUI(); // Actualizar UI para mostrar progreso
      
      try {
        let processedText = inputText;
        
        // Paso 1: Limpieza inicial
        updateProgress(10, "Limpiando texto...");
        processedText = cleanText(processedText);
        await sleep(200);
        
        // Paso 2: Reescritura Semántica Profunda
        updateProgress(30, "Reestructurando contenido...");
        processedText = deepSemanticRewrite(processedText, appState.settings);
        await sleep(200);
        
        // Paso 3: Simulación de Traducción (Enriquecimiento Léxico)
        updateProgress(50, "Enriqueciendo vocabulario...");
        processedText = translationSimulation(processedText, appState.settings);
        await sleep(200);
        
        // Paso 4: Fluidez Natural y Conectores
        updateProgress(70, "Mejorando fluidez...");
        processedText = addNaturalFlow(processedText, appState.settings);
        await sleep(200);
        
        // Paso 5: Ajuste de Tono y Legibilidad
        updateProgress(90, "Ajustando tono y legibilidad...");
        processedText = adjustToneAndReadability(processedText, appState.settings);
        await sleep(200);
        
        // Paso 6: Análisis Final y Puntuación
        updateProgress(100, "Analizando y finalizando...");
        const analysisScore = simulateStyleAnalysis(processedText, appState.settings);
        
        // Calcular estadísticas
        const wordsBefore = inputText.split(/\s+/).filter(w => w.length > 0).length;
        const wordsAfter = processedText.split(/\s+/).filter(w => w.length > 0).length;
        const readability = calculateReadability(processedText);
        
        // Actualizar estado
        appState.outputText = processedText;
        appState.analysisScore = analysisScore;
        appState.stats = { wordsBefore, wordsAfter, readability };
        
        // Guardar en historial local
        saveHistoryItem({
          original: inputText.substring(0, 100) + (inputText.length > 100 ? '...' : ''),
          result: processedText.substring(0, 100) + (processedText.length > 100 ? '...' : ''),
          date: new Date().toLocaleString(),
          score: analysisScore
        });
        
        // Cambiar a pestaña de resultados
        appState.activeTab = 'review';
        appState.isProcessing = false;
        
      } catch (err) {
        console.error("Error durante el procesamiento:", err);
        showError("Ocurrió un error al procesar el texto. Intenta de nuevo.");
        appState.isProcessing = false;
        appState.activeTab = 'write'; // Volver a editor en caso de error grave
      } finally {
        updateUI(); // Actualizar UI con resultados o estado de error
      }
    }

    // --- FUNCIONES DE ALMACENAMIENTO LOCAL ---
    function saveState() {
      localStorage.setItem('redactaproState', JSON.stringify(appState));
    }

    function loadState() {
      const savedState = localStorage.getItem('redactaproState');
      if (savedState) {
        const parsedState = JSON.parse(savedState);
        // Fusionar estado guardado con el actual, asegurando que las claves existan
        appState = { ...appState, ...parsedState };
        // Asegurarse de que los arreglos (historial) y objetos (settings) se carguen correctamente
        if (parsedState.conversionHistory) appState.conversionHistory = parsedState.conversionHistory;
        if (parsedState.settings) appState.settings = { ...appState.settings, ...parsedState.settings };
      }
    }

    function saveHistoryItem(item) {
      appState.conversionHistory.unshift(item);
      if (appState.conversionHistory.length > 5) { // Mantener solo los últimos 5
        appState.conversionHistory = appState.conversionHistory.slice(0, 5);
      }
      saveState();
    }

    // --- FUNCIONES DE UI ---
    function updateProgress(percent, message) {
      appState.processingProgress = percent;
      const progressBar = document.getElementById('progress-bar');
      if (progressBar) progressBar.style.width = `${percent}%`;
      const progressPercent = document.getElementById('progress-percent');
      if (progressPercent) progressPercent.textContent = `${percent}%`;
      const progressMessage = document.querySelector('#progress-container span:first-child');
      if (progressMessage) progressMessage.textContent = message;
    }

    function showError(message) {
      const errorElement = document.getElementById('error-message');
      if (!errorElement) return;
      document.getElementById('error-text').textContent = message;
      errorElement.classList.remove('hidden');
      setTimeout(() => errorElement.classList.add('hidden'), 5000);
    }

    function showToast(message) {
      const toast = document.getElementById('copy-toast');
      if (!toast) return;
      toast.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 2000);
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function updateUI() {
      const { inputText, outputText, isProcessing, analysisScore, activeTab, conversionHistory, stats, settings } = appState;
      
      // --- Navegación y Visibilidad de Secciones ---
      document.getElementById('write-section').classList.toggle('hidden', activeTab !== 'write');
      document.getElementById('analyze-section').classList.toggle('hidden', activeTab !== 'analyze');
      document.getElementById('review-section').classList.toggle('hidden', activeTab !== 'review');
      
      // Actualizar clases de botones de pestaña
      const updateTabButton = (id, isActive) => {
        const button = document.getElementById(id);
        if (button) {
          button.classList.toggle('tab-active', isActive);
          button.classList.toggle('tab-inactive', !isActive);
        }
      };
      updateTabButton('write-tab', activeTab === 'write');
      updateTabButton('analyze-tab', activeTab === 'analyze');
      updateTabButton('review-tab', activeTab === 'review');

      // --- Editor y Configuración ---
      const inputTextElement = document.getElementById('input-text');
      if (inputTextElement && inputTextElement.value !== inputText) {
          inputTextElement.value = inputText;
      }
      
      // Actualizar configuración guardada en la UI
      document.querySelector(`[data-depth="${settings.depth}"]`)?.classList.add('btn-primary');
      document.querySelectorAll('[data-depth]').forEach(btn => {
        if (btn.dataset.depth === settings.depth) {
          btn.classList.add('btn-primary', 'shadow-sm');
          btn.classList.remove('btn-secondary');
        } else {
          btn.classList.add('btn-secondary');
          btn.classList.remove('btn-primary', 'shadow-sm');
        }
      });

      document.getElementById('styleVariation').checked = settings.styleVariation;
      document.getElementById('naturalFlow').checked = settings.naturalFlow;
      document.getElementById('toneAdjustment').checked = settings.toneAdjustment;
      document.getElementById('readabilityFocus').checked = settings.readabilityFocus;
      document.getElementById('sentenceLengthVariation').checked = settings.sentenceLengthVariation;
      document.getElementById('connectorVariety').checked = settings.connectorVariety;
      document.getElementById('lexicalRichness').checked = settings.lexicalRichness;
      document.getElementById('avoidRepetition').checked = settings.avoidRepetition;
      
      // --- Barra de Progreso y Errores ---
      document.getElementById('progress-container').classList.toggle('hidden', !isProcessing);
      
      // --- Resultados ---
      document.getElementById('output-text').textContent = outputText || "El texto mejorado aparecerá aquí...";
      
      // Actualizar análisis
      const analysisScoreElement = document.getElementById('analysis-score');
      if (analysisScoreElement) analysisScoreElement.textContent = `${analysisScore.toFixed(1)}%`;
      const analysisBar = document.getElementById('analysis-bar');
      if (analysisBar) analysisBar.style.width = `${analysisScore}%`;
      
      let feedbackText = "Introduce texto y procesa para ver el análisis.";
      if (analysisScore > 80) {
        feedbackText = "Alta probabilidad de ser humano. ¡Excelente trabajo!";
      } else if (analysisScore > 60) {
        feedbackText = "Buena naturalidad, con algunos toques humanos.";
      } else if (analysisScore > 40) {
        feedbackText = "Indicios de patrones de IA detectados. Considera ajustes más profundos.";
      } else if (analysisScore > 0) {
        feedbackText = "Fuerte similitud con texto de IA. Revisa los ajustes de humanización.";
      }
      document.getElementById('analysis-feedback').textContent = feedbackText;
      
      // Actualizar estadísticas
      document.getElementById('words-before').textContent = stats.wordsBefore;
      document.getElementById('words-after').textContent = stats.wordsAfter;
      document.getElementById('readability-score').textContent = `${stats.readability.toFixed(1)}%`;
      
      // Calcular mejora general (ajustar pesos según importancia)
      const improvementScore = ((analysisScore / 100) * 40 + (stats.readability / 100) * 30 + (stats.wordsAfter > stats.wordsBefore ? 10 : 0) + (outputText ? 20 : 0)).toFixed(1);
      document.getElementById('improvement-score').textContent = `+${improvementScore}%`;
      
      // Actualizar historial
      const historyContainer = document.getElementById('history-container');
      const historyList = document.getElementById('history-list');
      
      if (conversionHistory.length > 0) {
        historyContainer.classList.remove('hidden');
        historyList.innerHTML = ''; // Limpiar lista existente
        
        conversionHistory.forEach((item, index) => {
          const historyItemDiv = document.createElement('div');
          historyItemDiv.className = 'history-item p-3 rounded-lg cursor-pointer';
          historyItemDiv.innerHTML = `
            <div class="flex justify-between items-start">
              <p class="text-sm text-slate-200 truncate font-medium">${item.original}</p>
              <span class="text-xs text-slate-400 whitespace-nowrap">${item.date}</span>
            </div>
            <div class="text-xs text-slate-300 mt-1">Puntuación: <span class="font-semibold text-yellow-300">${item.score.toFixed(1)}%</span> humano</div>
          `;
          
          // Añadir listener para cargar un elemento del historial
          historyItemDiv.addEventListener('click', () => {
            // Cargar el texto original y el resultado del historial
            appState.inputText = item.original.replace('...', ''); // Quitar '...' si estaba
            appState.outputText = item.result.replace('...', ''); // Idem
            appState.analysisScore = item.score;
            appState.stats = { // Necesitaríamos almacenar las stats completas o recalcular
              wordsBefore: item.original.split(' ').length, // Estimación simple
              wordsAfter: item.result.split(' ').length,   // Estimación simple
              readability: 0 // No se guarda, habría que recalcular
            };
            appState.activeTab = 'review';
            updateUI();
          });
          
          historyList.appendChild(historyItemDiv);
        });
      } else {
        historyContainer.classList.add('hidden');
      }
      
      // Advertencia de entrada vacía
      document.getElementById('input-warning').classList.toggle('hidden', inputText.trim().length > 0);
      
      // Estado del botón de procesamiento
      const processBtn = document.getElementById('process-btn');
      if (isProcessing) {
        processBtn.innerHTML = `
          <svg class="w-5 h-5 animate-spin text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Procesando...
        `;
        processBtn.disabled = true;
      } else {
        processBtn.innerHTML = `
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
          Humanizar y Analizar
        `;
        processBtn.disabled = false;
      }

      // Guardar estado actual en localStorage después de actualizar la UI
      saveState();
    }

    function copyToClipboard() {
      if (!appState.outputText) return;
      navigator.clipboard.writeText(appState.outputText).then(() => {
        showToast('¡Texto copiado al portapapeles!');
      }).catch(err => {
        console.error("Error copying to clipboard:", err);
        showError("No se pudo copiar el texto al portapapeles.");
      });
    }

    function downloadText(format) {
      if (!appState.outputText) return;
      
      let blob, filename;
      const timestamp = new Date().toISOString().split('T')[0]; // Fecha actual YYYY-MM-DD
      
      if (format === 'txt') {
        blob = new Blob([appState.outputText], { type: 'text/plain;charset=utf-8' });
        filename = `redactapro-texto-${timestamp}.txt`;
      } else if (format === 'doc') {
        const htmlContent = `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>Texto Humanizado - RedactaPro</title>
            <style>
              body { font-family: 'Inter', sans-serif; line-height: 1.6; color: #334155; }
              p { margin-bottom: 1em; }
            </style>
          </head>
          <body>
            <p>${appState.outputText.replace(/\n/g, '<br>')}</p>
          </body>
          </html>
        `;
        blob = new Blob([htmlContent], { type: 'application/msword' });
        filename = `redactapro-texto-${timestamp}.doc`;
      }
      
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Cargar configuración desde la UI al estado
    function loadSettingsFromUI() {
      appState.settings = {
        depth: document.querySelector('[data-depth].btn-primary')?.dataset.depth || 'suave',
        styleVariation: document.getElementById('styleVariation').checked,
        naturalFlow: document.getElementById('naturalFlow').checked,
        toneAdjustment: document.getElementById('toneAdjustment').checked,
        readabilityFocus: document.getElementById('readabilityFocus').checked,
        sentenceLengthVariation: document.getElementById('sentenceLengthVariation').checked,
        connectorVariety: document.getElementById('connectorVariety').checked,
        lexicalRichness: document.getElementById('lexicalRichness').checked,
        avoidRepetition: document.getElementById('avoidRepetition').checked,
      };
    }

    // --- INICIALIZACIÓN ---
    document.addEventListener('DOMContentLoaded', function() {
      // --- Cargar estado guardado ---
      loadState();

      // --- Event Listeners para Navegación y Botones ---
      document.getElementById('write-tab').addEventListener('click', () => {
        appState.activeTab = 'write'; updateUI();
      });
      document.getElementById('analyze-tab').addEventListener('click', () => {
        if (appState.inputText.trim()) { // Solo permitir si hay texto
          appState.activeTab = 'analyze'; updateUI();
        } else {
          showError("Por favor, introduce texto primero.");
        }
      });
      document.getElementById('review-tab').addEventListener('click', () => {
        if (appState.outputText) { // Solo permitir si hay resultado
          appState.activeTab = 'review'; updateUI();
        } else {
          showError("Procesa un texto para ver los resultados.");
        }
      });
      
      // Botones de profundidad
      document.querySelectorAll('[data-depth]').forEach(button => {
        button.addEventListener('click', () => {
          loadSettingsFromUI(); // Cargar la selección actual
          updateUI(); // Reflejar el cambio visual
        });
      });
      
      // Checkboxes de configuración
      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          loadSettingsFromUI();
          // No es necesario updateUI() aquí, solo se guarda en el estado
        });
      });
      
      // Botón de procesamiento principal
      document.getElementById('process-btn').addEventListener('click', processText);
      document.getElementById('process-from-analyze').addEventListener('click', processText);
      
      // Botón de copiar
      document.getElementById('copy-btn').addEventListener('click', copyToClipboard);
      
      // Botones de descarga
      document.querySelectorAll('.export-option').forEach(button => {
        button.addEventListener('click', (e) => {
          downloadText(e.target.dataset.format);
        });
      });
      
      // Botón de cargar archivo
      document.getElementById('load-file').addEventListener('click', () => {
        document.getElementById('file-input').click();
      });
      document.getElementById('file-input').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          appState.inputText = e.target.result;
          // Limpiar estado anterior al cargar un nuevo archivo
          appState.outputText = '';
          appState.analysisScore = 0;
          appState.stats = { wordsBefore: 0, wordsAfter: 0, readability: 0 };
          appState.activeTab = 'write';
          updateUI();
        };
        reader.onerror = () => showError("Error al leer el archivo.");
        reader.readAsText(file);
      });
      
      // Botones de limpieza
      document.getElementById('clear-input-btn').addEventListener('click', () => {
        appState.inputText = '';
        appState.outputText = '';
        appState.analysisScore = 0;
        appState.stats = { wordsBefore: 0, wordsAfter: 0, readability: 0 };
        appState.activeTab = 'write';
        updateUI();
      });
      document.getElementById('clear-all-btn').addEventListener('click', () => {
        appState = { // Resetear a estado inicial
          inputText: '', outputText: '', isProcessing: false, analysisScore: 0,
          processingProgress: 0, activeTab: 'write', conversionHistory: [],
          stats: { wordsBefore: 0, wordsAfter: 0, readability: 0 },
          settings: { // Resetear settings a defaults
            depth: 'suave', styleVariation: true, naturalFlow: true, toneAdjustment: true,
            readabilityFocus: true, sentenceLengthVariation: true, connectorVariety: true,
            lexicalRichness: true, avoidRepetition: true,
          }
        };
        localStorage.removeItem('redactaproState'); // Limpiar localStorage también
        updateUI();
      });
      
      // Botón de procesar otro texto
      document.getElementById('another-text-btn').addEventListener('click', () => {
        appState.activeTab = 'write';
        updateUI();
      });
      
      // --- Inicializar la UI ---
      updateUI();
    });
  </script>
</body>
</html>
